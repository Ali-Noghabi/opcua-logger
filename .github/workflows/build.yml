name: Build Standalone Executables

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  release:
    types: [ published ]

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        
    runs-on: ${{ matrix.os }}
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements_build.txt
    
    - name: Build executable (Linux/Mac)
      if: runner.os != 'Windows'
      run: |
        pyinstaller opcua_logger_gui.spec --clean --noconfirm
    
    - name: Build executable (Windows)
      if: runner.os == 'Windows'
      run: |
        pyinstaller opcua_logger_gui.spec --clean --noconfirm
    
    - name: Create distribution package
      shell: bash
      run: |
        mkdir -p dist/OPCUALoggerGUI_Distribution
        if [ "${{ runner.os }}" = "Windows" ]; then
          cp "dist/OPCUALoggerGUI.exe" "dist/OPCUALoggerGUI_Distribution/"
          cp "README_GUI.md" "dist/OPCUALoggerGUI_Distribution/"
          cp "sample_tags.csv" "dist/OPCUALoggerGUI_Distribution/"
          cp "config.yaml" "dist/OPCUALoggerGUI_Distribution/"
        else
          cp dist/OPCUALoggerGUI dist/OPCUALoggerGUI_Distribution/ || cp dist/OPCUALoggerGUI.app/Contents/MacOS/OPCUALoggerGUI dist/OPCUALoggerGUI_Distribution/OPCUALoggerGUI
          cp README_GUI.md dist/OPCUALoggerGUI_Distribution/
          cp sample_tags.csv dist/OPCUALoggerGUI_Distribution/
          cp config.yaml dist/OPCUALoggerGUI_Distribution/
        fi
    
    - name: Create archive
      shell: bash
      run: |
        cd dist
        if [ "${{ runner.os }}" = "Windows" ]; then
          7z a OPCUALoggerGUI_Windows.zip OPCUALoggerGUI_Distribution/
          echo "WINDOWS_ARCHIVE=OPCUALoggerGUI_Windows.zip" >> $GITHUB_ENV
        elif [ "${{ runner.os }}" = "macOS" ]; then
          tar -czf OPCUALoggerGUI_macOS.tar.gz OPCUALoggerGUI_Distribution/
          echo "MACOS_ARCHIVE=OPCUALoggerGUI_macOS.tar.gz" >> $GITHUB_ENV
        else
          tar -czf OPCUALoggerGUI_Linux.tar.gz OPCUALoggerGUI_Distribution/
          echo "LINUX_ARCHIVE=OPCUALoggerGUI_Linux.tar.gz" >> $GITHUB_ENV
        fi
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: opcua-logger-gui-${{ runner.os }}
        path: |
          dist/*.zip
          dist/*.tar.gz
        retention-days: 30
    
    - name: Upload release assets (Windows)
      if: github.event_name == 'release' && runner.os == 'Windows'
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: dist/${{ env.WINDOWS_ARCHIVE }}
        asset_name: OPCUALoggerGUI_Windows.zip
        asset_content_type: application/zip
    
    - name: Upload release assets (macOS)
      if: github.event_name == 'release' && runner.os == 'macOS'
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: dist/${{ env.MACOS_ARCHIVE }}
        asset_name: OPCUALoggerGUI_macOS.tar.gz
        asset_content_type: application/gzip
    
    - name: Upload release assets (Linux)
      if: github.event_name == 'release' && runner.os == 'Linux'
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: dist/${{ env.LINUX_ARCHIVE }}
        asset_name: OPCUALoggerGUI_Linux.tar.gz
        asset_content_type: application/gzip